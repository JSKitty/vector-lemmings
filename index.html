<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Lemmings</title>
  <link rel="icon" type="image/png" href="img/favicon.png">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
      touch-action: none;
    }
    .game, .game_container {
      display: block;
      touch-action: none;
      margin: auto;
      width: 100%;
      height: 100%;
    }
    canvas {
      width: 100% !important;
      height: 100% !important;
      object-fit: contain;
      image-rendering: pixelated;
    }
    .level_name {
      display: block;
      position: fixed;
      color: white;
      bottom: 8px;
      left: 8px;
      font-size: 13px;
      font-family: 'Segoe UI', system-ui, sans-serif;
      text-shadow: 1px 1px 2px #000;
      z-index: 100;
    }
    .arrow_l, .arrow_r {
      position: fixed;
      bottom: 4px;
      cursor: pointer;
      opacity: 0.7;
      z-index: 100;
    }
    .arrow_l:hover, .arrow_r:hover {
      opacity: 1;
    }
    .arrow_l {
      right: 60px;
    }
    .arrow_r {
      right: 10px;
    }
  </style>
</head>
<body oncontextmenu="return false;">
  <div class="game">
    <div class="game_container">
      <canvas height="480" width="800" id="gameCanvas"></canvas>
      <span id="levelName" class="level_name"></span>
      <img class="arrow_l" src="img/arrow_l.png" onclick="lemmings.moveToLevel(-1)">
      <img class="arrow_r" src="img/arrow_r.png" onclick="lemmings.moveToLevel(1)">
    </div>
  </div>

  <script src="js/jquery.js"></script>
  <script src="js/lemmings.js"></script>
  <script>
    var lemmings;

    function init() {
      lemmings = new Lemmings.GameView();
      lemmings.elementLevelName = document.getElementById("levelName");
      lemmings.gameCanvas = document.getElementById("gameCanvas");
      lemmings.setup();
      setupGamepad();

      // Start music after a short delay (needs user interaction for autoplay policy)
      document.addEventListener('click', function startMusic() {
        if (lemmings.playMusic) {
          lemmings.playMusic(0);
        }
        document.removeEventListener('click', startMusic);
      }, { once: true });
    }

    function setSize() {
      var ratio = 800 / 480;
      var gameContainer = document.querySelector(".game_container");
      var width = window.innerWidth;
      var height = window.innerHeight;

      if (width >= height * ratio) {
        gameContainer.style.width = (height * ratio) + 'px';
        gameContainer.style.height = height + 'px';
        gameContainer.style.marginTop = '';
        gameContainer.style.marginLeft = ((width - height * ratio) / 2) + 'px';
      } else {
        gameContainer.style.width = width + 'px';
        gameContainer.style.height = (width / ratio) + 'px';
        gameContainer.style.marginTop = ((height - width / ratio) / 2) + 'px';
        gameContainer.style.marginLeft = '';
      }
    }

    // Gamepad support
    var gamepadIndex = null;
    var gamepadState = {};

    function setupGamepad() {
      window.addEventListener('gamepadconnected', function(e) {
        gamepadIndex = e.gamepad.index;
        requestAnimationFrame(pollGamepad);
      });

      window.addEventListener('gamepaddisconnected', function(e) {
        if (e.gamepad.index === gamepadIndex) {
          gamepadIndex = null;
        }
      });

      var gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
      for (var i = 0; i < gamepads.length; i++) {
        if (gamepads[i]) {
          gamepadIndex = gamepads[i].index;
          requestAnimationFrame(pollGamepad);
          break;
        }
      }
    }

    function isButtonPressed(gp, index) {
      return gp.buttons[index] && gp.buttons[index].pressed;
    }

    function pollGamepad() {
      if (gamepadIndex === null) return;

      var gamepads = navigator.getGamepads();
      var gp = gamepads[gamepadIndex];
      if (!gp) {
        requestAnimationFrame(pollGamepad);
        return;
      }

      var mapping = [
        { input: function() { return isButtonPressed(gp, 4); }, action: function() { lemmings.moveToLevel(-1); } },
        { input: function() { return isButtonPressed(gp, 5); }, action: function() { lemmings.moveToLevel(1); } },
      ];

      mapping.forEach(function(m, i) {
        var pressed = m.input();
        var wasPressed = gamepadState[i];
        if (pressed && !wasPressed) {
          m.action();
        }
        gamepadState[i] = pressed;
      });

      requestAnimationFrame(pollGamepad);
    }

    window.addEventListener('load', function() {
      setSize();
      init();
    });

    window.addEventListener('resize', setSize);
    window.addEventListener('orientationchange', setSize);
  </script>
</body>
</html>
